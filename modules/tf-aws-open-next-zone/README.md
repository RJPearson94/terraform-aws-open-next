# Open Next Terraform - tf-aws-open-next-zone

This module allows you to deploy a next.js website using [Open Next](https://github.com/serverless-stack/open-next) to AWS utilizing lambda, S3 and CloudFront. Using this module will enable you to configure a single zone. If you want to manage [multiple zones](https://nextjs.org/docs/pages/building-your-application/deploying/multi-zones), please use the [tf-aws-open-next-multi-zone](../tf-aws-open-next-multi-zone) module instead.

The module will allow you to configure the following resources.

![Single Zone Complete](https://raw.githubusercontent.com/RJPearson94/terraform-aws-open-next/v2.2.2/docs/diagrams/Single%20Zone.png)

The following are optional:

- Route 53 (A and AAAA records)
- WAF
- Staging Distribution
- Warmer function
- Image Optimization function
- Tag to Path Mapping DB

See the module documentation section below for more info.

_Note:_ This module uses multiple bash scripts to delete data, upload data and mutate resources outside of Terraform. This prevents Terraform from removing resources when they have changed and allows the staging distribution functionality to work correctly. 

You must have bash and the AWS CLI available, the CLI must be configured to use the same credentials or environment variables as the default AWS provider for this functionality to work correctly.

If you need to destroy the Terraform resources, it is recommended that you enable `force_destroy` on the website bucket to delete the assets in the bucket when running a Terraform destory.

## Continuous deployment

This module supports CloudFront continuous deployment. See the [continuous deployment docs](https://github.com/RJPearson94/terraform-aws-open-next/blob/v2.3.0/docs/continuous-deployments.md) for instructions on how to leverage this capability.

## Backend Server Deployment Options

See the [backend server deployment docs](https://github.com/RJPearson94/terraform-aws-open-next/blob/v2.3.0/docs/backend-server-deployments.md) for instructions to see the options.

## Custom Domains

For infomation on managing custom domains see the [domain-config documentation](https://github.com/RJPearson94/terraform-aws-open-next/blob/v2.3.0/docs/domain-config.md)

## Module documentation

Below is the documentation for the Terraform module, outlining the providers, modules and resources required to deploy the website. The documentation includes the inputs that can be supplied (including any defaults) and what is outputted from the module.

By default, the module will zip all the necessary open-next artefacts as part of a Terraform deployment. To facilitate this, the .open-next folders need to be stored locally.

You can also choose to upload the artefacts to S3 and pass the reference in.

_Note:_ the logic to automatically inject environment variables for lambda@edge functions will not run if you choose this option

Alternatively you can create the zip using your own tooling and supply the path to the zip file and the hash (SHA256 hash of the file encoded using Base64).

You must configure the AWS providers five times because some organizations use different accounts or roles for IAM, DNS, etc. The module has been designed to cater for these requirements. The server function is a separate provider to allow your backend resources to be deployed to a region, i.e. eu-west-1, and deploy the server function to another region, i.e. us-east-1, for lambda@edge. The `global` provider region should be set to us-east-1 to allow the auth-function, WAF, etc. to be configured correctly.

Below is an example setup.

```tf
provider "aws" {}

provider "aws" {
  alias = "server_function"
}

provider "aws" {
  alias = "iam"
}

provider "aws" {
  alias = "dns"
}

provider "aws" {
  alias  = "global"
  region = "us-east-1"
}
```

### Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.4.0 |
| <a name="requirement_archive"></a> [archive](#requirement\_archive) | >= 2.3.0 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | >= 5.46.0 |
| <a name="requirement_local"></a> [local](#requirement\_local) | >= 2.4.0 |

### Providers

| Name | Version |
|------|---------|
| <a name="provider_archive"></a> [archive](#provider\_archive) | 2.4.0 |
| <a name="provider_aws"></a> [aws](#provider\_aws) | 5.27.0 |
| <a name="provider_local"></a> [local](#provider\_local) | 2.4.0 |
| <a name="provider_terraform"></a> [terraform](#provider\_terraform) | n/a |

### Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_image_optimisation_function"></a> [image\_optimisation\_function](#module\_image\_optimisation\_function) | ../tf-aws-lambda | n/a |
| <a name="module_open_next_aliases"></a> [open\_next\_aliases](#module\_open\_next\_aliases) | ../tf-aws-open-next-aliases | n/a |
| <a name="module_public_resources"></a> [public\_resources](#module\_public\_resources) | ../tf-aws-open-next-public-resources | n/a |
| <a name="module_revalidation_function"></a> [revalidation\_function](#module\_revalidation\_function) | ../tf-aws-lambda | n/a |
| <a name="module_s3_assets"></a> [s3\_assets](#module\_s3\_assets) | ../tf-aws-open-next-s3-assets | n/a |
| <a name="module_server_function"></a> [server\_function](#module\_server\_function) | ../tf-aws-lambda | n/a |
| <a name="module_warmer_function"></a> [warmer\_function](#module\_warmer\_function) | ../tf-aws-lambda | n/a |

### Resources

| Name | Type |
|------|------|
| [aws_dynamodb_table.isr_table](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/dynamodb_table) | resource |
| [aws_lambda_event_source_mapping.revalidation_queue_source](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_event_source_mapping) | resource |
| [aws_lambda_permission.image_optimisation_function_url_permission](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_permission) | resource |
| [aws_lambda_permission.server_function_url_permission](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_permission) | resource |
| [aws_s3_bucket.bucket](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket) | resource |
| [aws_s3_bucket_policy.bucket_policy](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket_policy) | resource |
| [aws_sqs_queue.revalidation_queue](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/sqs_queue) | resource |
| [local_file.lambda_at_edge_modifications](https://registry.terraform.io/providers/hashicorp/local/latest/docs/resources/file) | resource |
| terraform_data.isr_table_item | resource |
| terraform_data.update_aliases | resource |
| [archive_file.image_optimisation_function](https://registry.terraform.io/providers/hashicorp/archive/latest/docs/data-sources/file) | data source |
| [archive_file.revalidation_function](https://registry.terraform.io/providers/hashicorp/archive/latest/docs/data-sources/file) | data source |
| [archive_file.server_function](https://registry.terraform.io/providers/hashicorp/archive/latest/docs/data-sources/file) | data source |
| [archive_file.warmer_function](https://registry.terraform.io/providers/hashicorp/archive/latest/docs/data-sources/file) | data source |
| [aws_region.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/region) | data source |

### Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_aliases"></a> [aliases](#input\_aliases) | The production and staging aliases to use | <pre>object({<br>    production = string<br>    staging    = string<br>  })</pre> | `null` | no |
| <a name="input_behaviours"></a> [behaviours](#input\_behaviours) | Override the default behaviour config | <pre>object({<br>    custom_error_responses = optional(object({<br>      path_overrides = optional(map(object({<br>        allowed_methods          = optional(list(string))<br>        cached_methods           = optional(list(string))<br>        cache_policy_id          = optional(string)<br>        origin_request_policy_id = optional(string)<br>        compress                 = optional(bool)<br>        viewer_protocol_policy   = optional(string)<br>        viewer_request = optional(object({<br>          type         = string<br>          arn          = string<br>          include_body = optional(bool)<br>        }))<br>        viewer_response = optional(object({<br>          type = string<br>          arn  = string<br>        }))<br>        origin_request = optional(object({<br>          arn          = string<br>          include_body = bool<br>        }))<br>        origin_response = optional(object({<br>          arn = string<br>        }))<br>      })))<br>      allowed_methods          = optional(list(string))<br>      cached_methods           = optional(list(string))<br>      cache_policy_id          = optional(string)<br>      origin_request_policy_id = optional(string)<br>      compress                 = optional(bool)<br>      viewer_protocol_policy   = optional(string)<br>      viewer_request = optional(object({<br>        type         = string<br>        arn          = string<br>        include_body = optional(bool)<br>      }))<br>      viewer_response = optional(object({<br>        type = string<br>        arn  = string<br>      }))<br>      origin_request = optional(object({<br>        type         = string<br>        arn          = string<br>        include_body = optional(bool)<br>      }))<br>      origin_response = optional(object({<br>        type = string<br>        arn  = string<br>      }))<br>    }))<br>    static_assets = optional(object({<br>      paths            = optional(list(string))<br>      additional_paths = optional(list(string))<br>      path_overrides = optional(map(object({<br>        allowed_methods          = optional(list(string))<br>        cached_methods           = optional(list(string))<br>        cache_policy_id          = optional(string)<br>        origin_request_policy_id = optional(string)<br>        compress                 = optional(bool)<br>        viewer_protocol_policy   = optional(string)<br>        viewer_request = optional(object({<br>          type         = string<br>          arn          = string<br>          include_body = optional(bool)<br>        }))<br>        viewer_response = optional(object({<br>          type = string<br>          arn  = string<br>        }))<br>        origin_request = optional(object({<br>          arn          = string<br>          include_body = bool<br>        }))<br>        origin_response = optional(object({<br>          arn = string<br>        }))<br>      })))<br>      allowed_methods          = optional(list(string))<br>      cached_methods           = optional(list(string))<br>      cache_policy_id          = optional(string)<br>      origin_request_policy_id = optional(string)<br>      compress                 = optional(bool)<br>      viewer_protocol_policy   = optional(string)<br>      viewer_request = optional(object({<br>        type         = string<br>        arn          = string<br>        include_body = optional(bool)<br>      }))<br>      viewer_response = optional(object({<br>        type = string<br>        arn  = string<br>      }))<br>      origin_request = optional(object({<br>        type         = string<br>        arn          = string<br>        include_body = optional(bool)<br>      }))<br>      origin_response = optional(object({<br>        type = string<br>        arn  = string<br>      }))<br>    }))<br>    server = optional(object({<br>      paths = optional(list(string))<br>      path_overrides = optional(map(object({<br>        allowed_methods          = optional(list(string))<br>        cached_methods           = optional(list(string))<br>        cache_policy_id          = optional(string)<br>        origin_request_policy_id = optional(string)<br>        compress                 = optional(bool)<br>        viewer_protocol_policy   = optional(string)<br>        viewer_request = optional(object({<br>          type         = string<br>          arn          = string<br>          include_body = optional(bool)<br>        }))<br>        viewer_response = optional(object({<br>          type = string<br>          arn  = string<br>        }))<br>        origin_request = optional(object({<br>          arn          = string<br>          include_body = bool<br>        }))<br>        origin_response = optional(object({<br>          arn = string<br>        }))<br>      })))<br>      allowed_methods          = optional(list(string))<br>      cached_methods           = optional(list(string))<br>      cache_policy_id          = optional(string)<br>      origin_request_policy_id = optional(string)<br>      compress                 = optional(bool)<br>      viewer_protocol_policy   = optional(string)<br>      viewer_request = optional(object({<br>        type         = string<br>        arn          = string<br>        include_body = optional(bool)<br>      }))<br>      viewer_response = optional(object({<br>        type = string<br>        arn  = string<br>      }))<br>      origin_request = optional(object({<br>        type         = string<br>        arn          = string<br>        include_body = optional(bool)<br>      }))<br>      origin_response = optional(object({<br>        type = string<br>        arn  = string<br>      }))<br>    }))<br>    image_optimisation = optional(object({<br>      paths = optional(list(string))<br>      path_overrides = optional(map(object({<br>        allowed_methods          = optional(list(string))<br>        cached_methods           = optional(list(string))<br>        cache_policy_id          = optional(string)<br>        origin_request_policy_id = optional(string)<br>        compress                 = optional(bool)<br>        viewer_protocol_policy   = optional(string)<br>        viewer_request = optional(object({<br>          type         = string<br>          arn          = string<br>          include_body = optional(bool)<br>        }))<br>        viewer_response = optional(object({<br>          type = string<br>          arn  = string<br>        }))<br>        origin_request = optional(object({<br>          arn          = string<br>          include_body = bool<br>        }))<br>        origin_response = optional(object({<br>          arn = string<br>        }))<br>      })))<br>      allowed_methods          = optional(list(string))<br>      cached_methods           = optional(list(string))<br>      cache_policy_id          = optional(string)<br>      origin_request_policy_id = optional(string)<br>      compress                 = optional(bool)<br>      viewer_protocol_policy   = optional(string)<br>      viewer_request = optional(object({<br>        type         = string<br>        arn          = string<br>        include_body = optional(bool)<br>      }))<br>      viewer_response = optional(object({<br>        type = string<br>        arn  = string<br>      }))<br>      origin_request = optional(object({<br>        type         = string<br>        arn          = string<br>        include_body = optional(bool)<br>      }))<br>      origin_response = optional(object({<br>        type = string<br>        arn  = string<br>      }))<br>    }))<br>  })</pre> | `{}` | no |
| <a name="input_cache_control_immutable_assets_regex"></a> [cache\_control\_immutable\_assets\_regex](#input\_cache\_control\_immutable\_assets\_regex) | Regex to set public,max-age=31536000,immutable on immutable resources | `string` | `"^.*(\\.next)$"` | no |
| <a name="input_cloudwatch_log"></a> [cloudwatch\_log](#input\_cloudwatch\_log) | The default cloudwatch log group. This can be overridden for each function. | <pre>object({<br>    retention_in_days = number<br>  })</pre> | <pre>{<br>  "retention_in_days": 7<br>}</pre> | no |
| <a name="input_content_types"></a> [content\_types](#input\_content\_types) | The MIME type mapping and default for artefacts generated by Open Next | <pre>object({<br>    mapping = optional(map(string), {<br>      "svg"  = "image/svg+xml",<br>      "js"   = "application/javascript",<br>      "css"  = "text/css",<br>      "html" = "text/html"<br>    })<br>    default = optional(string, "binary/octet-stream")<br>  })</pre> | `{}` | no |
| <a name="input_continuous_deployment"></a> [continuous\_deployment](#input\_continuous\_deployment) | Configuration for continuous deployment config for CloudFront<br><br>See https://github.com/RJPearson94/terraform-aws-open-next/blob/v2.3.0/docs/continuous-deployments.md for a complete breakdown of how to use continuous deployment. | <pre>object({<br>    use        = optional(bool, true)<br>    deployment = optional(string, "NONE")<br>    traffic_config = optional(object({<br>      header = optional(object({<br>        name  = string<br>        value = string<br>      }))<br>      weight = optional(object({<br>        percentage = number<br>        session_stickiness = optional(object({<br>          idle_ttl    = number<br>          maximum_ttl = number<br>        }))<br>      }))<br>    }))<br>  })</pre> | `{}` | no |
| <a name="input_custom_error_responses"></a> [custom\_error\_responses](#input\_custom\_error\_responses) | Allow custom error responses to be set on the distributions<br><br>**NOTE:** These custom error pages only apply to response codes from the origins. To configure custom error responses for status codes returned by WAF, please configure the custom error responses in WAF. | <pre>list(object({<br>    error_code            = string<br>    error_caching_min_ttl = optional(number)<br>    response_code         = optional(string)<br>    response_page = optional(object({<br>      source      = string<br>      path_prefix = string<br>    }))<br>  }))</pre> | `[]` | no |
| <a name="input_distribution"></a> [distribution](#input\_distribution) | Configuration for the CloudFront distribution. <br><br>Possible values for deployment are:<br>- NONE<br>- CREATE<br><br>The module has a local copy of the x-forwarded host CloudFront function code by default. The code can be seen at https://github.com/RJPearson94/terraform-aws-open-next/blob/v2.3.0/modules/tf-aws-open-next-public-resources/code/xForwardedHost.js. <br><br>This code can be overridden by passing in the javascript function as a string to the `code` argument under the `x_forwarded_host_function` object. An example can be seen below.<pre>x_forwarded_host_function = {<br>  code = "function handler(event) { var request = event.request; request.headers['x-forwarded-host'] = request.headers.host; return request; }"<br>}</pre>The auth function is deployed if the server function backend\_deployment\_type is set to EDGE\_LAMBDA.<br><br>The module has a local copy of the auth function code, which will be deployed by default. The code can be seen at https://github.com/RJPearson94/terraform-aws-open-next/blob/v2.3.0/modules/tf-aws-open-next-public-resources/code/auth/index.js. You can override this to supplying a zip file containing the lambda code with either a local reference or a reference to the zip in an S3 bucket.<br><br>Possible values for the auth\_function deployment are:<br>- NONE <br>- USE\_EXISTING<br>- CREATE<br>- DETACH<br><br>The auth function arn is mandatory when deployment is set to `USE_EXISTING`.<br><br>When migrating from using the auth function to either public cloud functions or to using OAC, you should set the deployment on the auth\_function to CREATE, then apply the changes. Then, you can set deployment to false in a subsequent change to clean up the function.<br><br>If you run the server function as a lambda@edge, you should increase the deletion timeout to 2 hours `120m`. As the lambda service needs to wait for the replicas to be removed, this often exceeds the default 10-minute deletion timeout. This extended timeout allows Terraform to poll for longer and should help mitigate Terraform failures; an example Terraform configuration can be seen below.<pre>auth_function = {<br>  timeouts = {<br>    deletion = "120m"<br>  }<br>}</pre>As lambda@edge doesn't support environment variables, the environment variables are injected into the source code before the zip is generated. <br>**NOTE:** If the lambda function code is supplied as a zip or via an S3 reference, this code modification will not occur<br><br>Terraform does not manage cloudwatch log groups for the auth function; the lambda service creates the log group when the function runs in each region.<br>The inclusion of the variable is a mistake; this is deprecated and will be removed in the next major version of the module.<br><br>CloudFront supports Origin Access Control (OAC) for lambda URLs. The possible values for the deployment options are:<br>- NONE<br>- CREATE<br><br>**NOTE:** If the server function or image optimisation function backend deployment types use OAC, then the OAC will be created.<br><br>As there is a limit on the number of cache policies associated with an AWS account, you can either configure the module to create the cache policy or use an existing one. The possible values for the cache policy deployment are:<br>- USE\_EXISTING<br>- CREATE<br><br>If cache policy deployment is set to `USE_EXISTING`, then ID, is a required field.<br><br>**NOTE:** Please use ID as ARN for the cache policy is deprecated<br><br>**WARNING:** The distribution is fundamental to the architecture, and the module is optional to facilitate sharing a distribution for multi-zone deployments and to support edge cases not supported by the module. With that said, it is not recommended to supply a distribution. | <pre>object({<br>    deployment   = optional(string, "CREATE")<br>    enabled      = optional(bool, true)<br>    ipv6_enabled = optional(bool, true)<br>    http_version = optional(string, "http2")<br>    price_class  = optional(string, "PriceClass_100")<br>    geo_restrictions = optional(object({<br>      type      = optional(string, "none"),<br>      locations = optional(list(string), [])<br>    }), {})<br>    x_forwarded_host_function = optional(object({<br>      runtime = optional(string)<br>      code    = optional(string)<br>    }), {})<br>    auth_function = optional(object({<br>      deployment    = optional(string, "NONE")<br>      qualified_arn = optional(string)<br>      function_code = optional(object({<br>        handler = optional(string, "index.handler")<br>        zip = optional(object({<br>          path = string<br>          hash = string<br>        }))<br>        s3 = optional(object({<br>          bucket         = string<br>          key            = string<br>          object_version = optional(string)<br>        }))<br>      }))<br>      runtime     = optional(string, "nodejs20.x")<br>      timeout     = optional(number, 10)<br>      memory_size = optional(number, 256)<br>      additional_iam_policies = optional(list(object({<br>        name   = string,<br>        arn    = optional(string)<br>        policy = optional(string)<br>      })), [])<br>      iam = optional(object({<br>        path                 = optional(string)<br>        permissions_boundary = optional(string)<br>      }))<br>      cloudwatch_log = optional(object({<br>        retention_in_days = number<br>      }))<br>      timeouts = optional(object({<br>        create = optional(string)<br>        update = optional(string)<br>        delete = optional(string)<br>      }), {})<br>    }), {})<br>    lambda_url_oac = optional(object({<br>      deployment = optional(string, "NONE")<br>    }), {})<br>    cache_policy = optional(object({<br>      deployment            = optional(string, "CREATE")<br>      arn                   = optional(string)<br>      id                    = optional(string)<br>      default_ttl           = optional(number, 0)<br>      max_ttl               = optional(number, 31536000)<br>      min_ttl               = optional(number, 0)<br>      cookie_behavior       = optional(string, "all")<br>      header_behavior       = optional(string, "whitelist")<br>      header_items          = optional(list(string), ["accept", "rsc", "next-router-prefetch", "next-router-state-tree", "next-url"])<br>      query_string_behavior = optional(string, "all")<br>    }), {})<br>  })</pre> | `{}` | no |
| <a name="input_domain_config"></a> [domain\_config](#input\_domain\_config) | Configuration for CloudFront distribution domain<br><br>See https://github.com/RJPearson94/terraform-aws-open-next/blob/v2.3.0/docs/domain-config.md for a complete breakdown of the different domain configuration options. | <pre>object({<br>    evaluate_target_health = optional(bool, true)<br>    include_www            = optional(bool, false)<br>    sub_domain             = optional(string)<br>    hosted_zones = list(object({<br>      name         = string<br>      id           = optional(string)<br>      private_zone = optional(bool, false)<br>    }))<br>    create_route53_entries         = optional(bool, true)<br>    route53_record_allow_overwrite = optional(bool, true)<br>    viewer_certificate = optional(object({<br>      acm_certificate_arn      = string<br>      ssl_support_method       = optional(string, "sni-only")<br>      minimum_protocol_version = optional(string, "TLSv1.2_2021")<br>    }))<br>  })</pre> | `null` | no |
| <a name="input_folder_path"></a> [folder\_path](#input\_folder\_path) | The path to the open next artifacts | `string` | n/a | yes |
| <a name="input_function_architecture"></a> [function\_architecture](#input\_function\_architecture) | The default instruction set architecture for the lambda functions. This can be overridden for each function. | `string` | `"arm64"` | no |
| <a name="input_iam"></a> [iam](#input\_iam) | The default IAM configuration. This can be overridden for each function. | <pre>object({<br>    path                 = optional(string, "/")<br>    permissions_boundary = optional(string)<br>  })</pre> | `{}` | no |
| <a name="input_image_optimisation_function"></a> [image\_optimisation\_function](#input\_image\_optimisation\_function) | Configuration for the image optimisation function.<br><br>By default, the module will create a new zip from the image optimisation function code on disk. However, you can override this by supplying a zip file containing the lambda code with either a local reference or a reference to the zip in an S3 bucket.<br><br>Possible values for backend\_deployment\_type: <br>  - REGIONAL\_LAMBDA\_WITH\_AUTH\_LAMBDA<br>  - REGIONAL\_LAMBDA\_WITH\_OAC<br>  - REGIONAL\_LAMBDA\_WITH\_OAC\_AND\_ANY\_PRINCIPAL<br>  - REGIONAL\_LAMBDA<br><br>See https://github.com/RJPearson94/terraform-aws-open-next/blob/v2.3.0/docs/backend-server-deployments.md for a complete breakdown of the different backend options.<br><br>If you do not want to provision the image optimisation function, you can set `create` to false. | <pre>object({<br>    create = optional(bool, true)<br>    function_code = optional(object({<br>      handler = optional(string, "index.handler")<br>      zip = optional(object({<br>        path = string<br>        hash = string<br>      }))<br>      s3 = optional(object({<br>        bucket         = string<br>        key            = string<br>        object_version = optional(string)<br>      }))<br>    }))<br>    runtime                          = optional(string, "nodejs20.x")<br>    backend_deployment_type          = optional(string, "REGIONAL_LAMBDA")<br>    timeout                          = optional(number, 25)<br>    memory_size                      = optional(number, 1536)<br>    additional_environment_variables = optional(map(string), {})<br>    function_architecture            = optional(string)<br>    additional_iam_policies = optional(list(object({<br>      name   = string,<br>      arn    = optional(string)<br>      policy = optional(string)<br>    })), [])<br>    vpc = optional(object({<br>      security_group_ids = list(string),<br>      subnet_ids         = list(string)<br>    }))<br>    iam = optional(object({<br>      path                 = optional(string)<br>      permissions_boundary = optional(string)<br>    }))<br>    cloudwatch_log = optional(object({<br>      retention_in_days = number<br>    }))<br>    timeouts = optional(object({<br>      create = optional(string)<br>      update = optional(string)<br>      delete = optional(string)<br>    }), {})<br>  })</pre> | `{}` | no |
| <a name="input_prefix"></a> [prefix](#input\_prefix) | A prefix which will be attached to the resource name to ensure resources are random | `string` | `null` | no |
| <a name="input_revalidation_function"></a> [revalidation\_function](#input\_revalidation\_function) | Configuration for the revalidation function.<br><br>By default, the module will create a new zip from the revalidation function code on disk. However, you can override this by supplying a zip file containing the lambda code with either a local reference or a reference to the zip in an S3 bucket.<br><br>This function is deployed to the region specified on the default AWS Terraform provider. | <pre>object({<br>    function_code = optional(object({<br>      handler = optional(string, "index.handler")<br>      zip = optional(object({<br>        path = string<br>        hash = string<br>      }))<br>      s3 = optional(object({<br>        bucket         = string<br>        key            = string<br>        object_version = optional(string)<br>      }))<br>    }))<br>    runtime                          = optional(string, "nodejs20.x")<br>    timeout                          = optional(number, 25)<br>    memory_size                      = optional(number, 1536)<br>    additional_environment_variables = optional(map(string), {})<br>    function_architecture            = optional(string)<br>    additional_iam_policies = optional(list(object({<br>      name   = string,<br>      arn    = optional(string)<br>      policy = optional(string)<br>    })), [])<br>    vpc = optional(object({<br>      security_group_ids = list(string),<br>      subnet_ids         = list(string)<br>    }))<br>    iam = optional(object({<br>      path                 = optional(string)<br>      permissions_boundary = optional(string)<br>    }))<br>    cloudwatch_log = optional(object({<br>      retention_in_days = number<br>    }))<br>    timeouts = optional(object({<br>      create = optional(string)<br>      update = optional(string)<br>      delete = optional(string)<br>    }), {})<br>  })</pre> | `{}` | no |
| <a name="input_s3_exclusion_regex"></a> [s3\_exclusion\_regex](#input\_s3\_exclusion\_regex) | A regex of files to exclude from the s3 copy | `string` | `null` | no |
| <a name="input_s3_folder_prefix"></a> [s3\_folder\_prefix](#input\_s3\_folder\_prefix) | An optional folder to store uploaded assets and cached files under | `string` | `null` | no |
| <a name="input_scripts"></a> [scripts](#input\_scripts) | Modify default script behaviours | <pre>object({<br>    interpreter                      = optional(string)<br>    additional_environment_variables = optional(map(string))<br>    delete_folder_script = optional(object({<br>      interpreter                      = optional(string)<br>      path                             = optional(string)<br>      additional_environment_variables = optional(map(string))<br>    }))<br>    file_sync_script = optional(object({<br>      interpreter                      = optional(string)<br>      path                             = optional(string)<br>      additional_environment_variables = optional(map(string))<br>    }))<br>    invalidate_cloudfront_script = optional(object({<br>      interpreter                      = optional(string)<br>      path                             = optional(string)<br>      additional_environment_variables = optional(map(string))<br>    }))<br>    promote_distribution_script = optional(object({<br>      interpreter                      = optional(string)<br>      path                             = optional(string)<br>      additional_environment_variables = optional(map(string))<br>    }))<br>    remove_continuous_deployment_policy_id_script = optional(object({<br>      interpreter                      = optional(string)<br>      path                             = optional(string)<br>      additional_environment_variables = optional(map(string))<br>    }))<br>    save_item_to_dynamo_script = optional(object({<br>      interpreter                      = optional(string)<br>      path                             = optional(string)<br>      additional_environment_variables = optional(map(string))<br>    }))<br>    update_alias_script = optional(object({<br>      interpreter                      = optional(string)<br>      path                             = optional(string)<br>      additional_environment_variables = optional(map(string))<br>    }))<br>    update_parameter_script = optional(object({<br>      interpreter                      = optional(string)<br>      path                             = optional(string)<br>      additional_environment_variables = optional(map(string))<br>    }))<br>  })</pre> | `{}` | no |
| <a name="input_server_function"></a> [server\_function](#input\_server\_function) | Configuration for the server function.<br><br>By default, the module will create a new zip from the server function code on disk. However, you can override this by supplying a zip file containing the lambda code with either a local reference or a reference to the zip in an S3 bucket.<br><br>Possible values for backend\_deployment\_type: <br>  - REGIONAL\_LAMBDA\_WITH\_AUTH\_LAMBDA<br>  - REGIONAL\_LAMBDA\_WITH\_OAC<br>  - REGIONAL\_LAMBDA\_WITH\_OAC\_AND\_ANY\_PRINCIPAL<br>  - REGIONAL\_LAMBDA<br>  - EDGE\_LAMBDA<br><br>See https://github.com/RJPearson94/terraform-aws-open-next/blob/v2.3.0/docs/backend-server-deployments.md for a complete breakdown of the different backend options.<br><br>**NOTE:** When backend\_deployment\_type is set to EDGE\_LAMBDA, Terraform does not manage cloudwatch log groups; instead, the lambda service creates the log group when the function runs in each region.<br><br>If you run the server function as a lambda@edge, you should increase the deletion timeout to 2 hours `120m`. As the lambda service needs to wait for the replicas to be removed, this often exceeds the default 10-minute deletion timeout. This extended timeout allows Terraform to poll for longer and should help mitigate Terraform failures; an example Terraform configuration can be seen below.<pre>timeouts = {<br>  deletion = "120m"<br>}</pre>As lambda@edge doesn't support environment variables, the environment variables are injected into the source code before the zip is generated. <br>**NOTE:** If the lambda function code is supplied as a zip or via an S3 reference, this code modification will not occur | <pre>object({<br>    function_code = optional(object({<br>      handler = optional(string, "index.handler")<br>      zip = optional(object({<br>        path = string<br>        hash = string<br>      }))<br>      s3 = optional(object({<br>        bucket         = string<br>        key            = string<br>        object_version = optional(string)<br>      }))<br>    }))<br>    enable_streaming                 = optional(bool, false)<br>    runtime                          = optional(string, "nodejs20.x")<br>    backend_deployment_type          = optional(string, "REGIONAL_LAMBDA")<br>    timeout                          = optional(number, 10)<br>    memory_size                      = optional(number, 1024)<br>    function_architecture            = optional(string)<br>    additional_environment_variables = optional(map(string), {})<br>    additional_iam_policies = optional(list(object({<br>      name   = string,<br>      arn    = optional(string)<br>      policy = optional(string)<br>    })), [])<br>    vpc = optional(object({<br>      security_group_ids = list(string),<br>      subnet_ids         = list(string)<br>    }))<br>    iam = optional(object({<br>      path                 = optional(string)<br>      permissions_boundary = optional(string)<br>    }))<br>    cloudwatch_log = optional(object({<br>      retention_in_days = number<br>    }))<br>    timeouts = optional(object({<br>      create = optional(string)<br>      update = optional(string)<br>      delete = optional(string)<br>    }), {})<br>  })</pre> | `{}` | no |
| <a name="input_suffix"></a> [suffix](#input\_suffix) | A suffix which will be attached to the resource name to ensure resources are random | `string` | `null` | no |
| <a name="input_tag_mapping_db"></a> [tag\_mapping\_db](#input\_tag\_mapping\_db) | Configuration for the ISR tag mapping database<br><br>By default, the module uploads the items in the dynamodb-cache JSON file stored locally. The cache alias is appended to each item in the DB.<br><br>Possible values for deployment:<br>- NONE<br>- CREATE<br><br>The read and write capacity for the Global Secondary Index (GSI) can be overridden; however, the table's read and write capacity will be used by default. | <pre>object({<br>    deployment     = optional(string, "CREATE")<br>    billing_mode   = optional(string, "PAY_PER_REQUEST")<br>    read_capacity  = optional(number)<br>    write_capacity = optional(number)<br>    revalidate_gsi = optional(object({<br>      read_capacity  = optional(number)<br>      write_capacity = optional(number)<br>    }), {})<br>  })</pre> | `{}` | no |
| <a name="input_vpc"></a> [vpc](#input\_vpc) | The default VPC configuration for the lambda resources. This can be overridden for each function. | <pre>object({<br>    security_group_ids = list(string),<br>    subnet_ids         = list(string)<br>  })</pre> | `null` | no |
| <a name="input_waf"></a> [waf](#input\_waf) | Configuration for the CloudFront distribution WAF.<br><br>Possible values for the WAF deployment are:<br>- NONE <br>- USE\_EXISTING<br>- CREATE<br>- DETACH<br><br>The web\_acl\_id is mandatory when deployment is set to `USE_EXISTING`.<br><br>When configuring basic authentication, the encoded username and password are marked as sensitive. This can be turned off by setting `mark_as_sensitive` to false; however, a bug in Terraform v1.6.0 prevented this from working. If this occurs, please upgrade to at least v1.6.1.<br><br>Possible values for the WAF default action are:<br>- ALLOW<br>- BLOCK<br><br>The module provides the ability to configure recommended WAF rules to guard against SQL Injection (sqli), account takeover protection and account creation fraud prevention.<br><br>Multiple rate limits can be configured with each limit applied across all geographic regions or limited to a specific region. The possible values for the action are:<br>- COUNT<br>- BLOCK<br><br> The possible values for the action of each additional rule are:<br>- COUNT<br>- BLOCK<br><br>When IP address restrictions are used as part of additional rules or enforcing basic auth, the possible values for the action are:<br>- BYPASS<br>- BLOCK<br><br>Examples of maintenance pages, basic auth, and more can be found at https://github.com/RJPearson94/terraform-aws-open-next-examples. | <pre>object({<br>    deployment = optional(string, "NONE")<br>    web_acl_id = optional(string)<br>    aws_managed_rules = optional(list(object({<br>      priority              = optional(number)<br>      name                  = string<br>      aws_managed_rule_name = string<br>      })), [{<br>      name                  = "amazon-ip-reputation-list"<br>      aws_managed_rule_name = "AWSManagedRulesAmazonIpReputationList"<br>      }, {<br>      name                  = "common-rule-set"<br>      aws_managed_rule_name = "AWSManagedRulesCommonRuleSet"<br>      }, {<br>      name                  = "known-bad-inputs"<br>      aws_managed_rule_name = "AWSManagedRulesKnownBadInputsRuleSet"<br>    }])<br>    rate_limiting = optional(object({<br>      enabled = optional(bool, false)<br>      limits = optional(list(object({<br>        priority         = optional(number)<br>        rule_name_suffix = optional(string)<br>        limit            = optional(number, 1000)<br>        action           = optional(string, "BLOCK")<br>        geo_match_scope  = optional(list(string))<br>      })), [])<br>    }), {})<br>    sqli = optional(object({<br>      enabled  = optional(bool, false)<br>      priority = optional(number)<br>    }), {})<br>    account_takeover_protection = optional(object({<br>      enabled              = optional(bool, false)<br>      priority             = optional(number)<br>      login_path           = string<br>      enable_regex_in_path = optional(bool)<br>      request_inspection = optional(object({<br>        username_field_identifier = string<br>        password_field_identifier = string<br>        payload_type              = string<br>      }))<br>      response_inspection = optional(object({<br>        failure_codes = list(string)<br>        success_codes = list(string)<br>      }))<br>    }))<br>    account_creation_fraud_prevention = optional(object({<br>      enabled                = optional(bool, false)<br>      priority               = optional(number)<br>      creation_path          = string<br>      registration_page_path = string<br>      enable_regex_in_path   = optional(bool)<br>      request_inspection = optional(object({<br>        email_field_identifier    = string<br>        username_field_identifier = string<br>        password_field_identifier = string<br>        payload_type              = string<br>      }))<br>      response_inspection = optional(object({<br>        failure_codes = list(string)<br>        success_codes = list(string)<br>      }))<br>    }))<br>    enforce_basic_auth = optional(object({<br>      enabled       = optional(bool, false)<br>      priority      = optional(number)<br>      response_code = optional(number, 401)<br>      response_header = optional(object({<br>        name  = optional(string, "WWW-Authenticate")<br>        value = optional(string, "Basic realm=\"Requires basic auth\"")<br>      }), {})<br>      header_name = optional(string, "authorization")<br>      credentials = optional(object({<br>        username          = string<br>        password          = string<br>        mark_as_sensitive = optional(bool, true)<br>      }))<br>      ip_address_restrictions = optional(list(object({<br>        action = optional(string, "BYPASS")<br>        arn    = optional(string)<br>        name   = optional(string)<br>      })))<br>    }))<br>    additional_rules = optional(list(object({<br>      enabled  = optional(bool, false)<br>      priority = optional(number)<br>      name     = string<br>      action   = optional(string, "COUNT")<br>      block_action = optional(object({<br>        response_code = number<br>        response_header = optional(object({<br>          name  = string<br>          value = string<br>        }))<br>        custom_response_body_key = optional(string)<br>      }))<br>      ip_address_restrictions = list(object({<br>        action = optional(string, "BYPASS")<br>        arn    = optional(string)<br>        name   = optional(string)<br>      }))<br>    })))<br>    default_action = optional(object({<br>      action = optional(string, "ALLOW")<br>      block_action = optional(object({<br>        response_code = number<br>        response_header = optional(object({<br>          name  = string<br>          value = string<br>        }))<br>        custom_response_body_key = optional(string)<br>      }))<br>    }))<br>    ip_addresses = optional(map(object({<br>      description        = optional(string)<br>      ip_address_version = string<br>      addresses          = list(string)<br>    })))<br>    custom_response_bodies = optional(list(object({<br>      key          = string<br>      content      = string<br>      content_type = string<br>    })))<br>  })</pre> | `{}` | no |
| <a name="input_warmer_function"></a> [warmer\_function](#input\_warmer\_function) | Configuration for the warmer function.<br><br>By default, the module will create a new zip from the warmer function code on disk. However, you can override this by supplying a zip file containing the lambda code with either a local reference or a reference to the zip in an S3 bucket.<br><br>If the warmer function is enabled, you can conditionally choose to warm the staging distribution. Enabling this will provision another lambda function. By default, the warmer for the staging distribution will use the same concurrency value as the production distribution. However, you can override this value by specifying a `concurrency` value for the `warm_staging` object.<br><br>This function is deployed to the region specified on the default AWS Terraform provider. | <pre>object({<br>    enabled = optional(bool, false)<br>    warm_staging = optional(object({<br>      enabled     = optional(bool, false)<br>      concurrency = optional(number)<br>    }))<br>    function_code = optional(object({<br>      handler = optional(string, "index.handler")<br>      zip = optional(object({<br>        path = string<br>        hash = string<br>      }))<br>      s3 = optional(object({<br>        bucket         = string<br>        key            = string<br>        object_version = optional(string)<br>      }))<br>    }))<br>    runtime                          = optional(string, "nodejs20.x")<br>    concurrency                      = optional(number, 20)<br>    timeout                          = optional(number, 15 * 60) // 15 minutes<br>    memory_size                      = optional(number, 1024)<br>    function_architecture            = optional(string)<br>    schedule                         = optional(string, "rate(5 minutes)")<br>    additional_environment_variables = optional(map(string), {})<br>    additional_iam_policies = optional(list(object({<br>      name   = string,<br>      arn    = optional(string)<br>      policy = optional(string)<br>    })), [])<br>    vpc = optional(object({<br>      security_group_ids = list(string),<br>      subnet_ids         = list(string)<br>    }))<br>    iam = optional(object({<br>      path                 = optional(string)<br>      permissions_boundary = optional(string)<br>    }))<br>    cloudwatch_log = optional(object({<br>      retention_in_days = number<br>    }))<br>    timeouts = optional(object({<br>      create = optional(string)<br>      update = optional(string)<br>      delete = optional(string)<br>    }), {})<br>  })</pre> | `{}` | no |
| <a name="input_website_bucket"></a> [website\_bucket](#input\_website\_bucket) | Configuration for the website S3 bucket<br><br>By default, the module will upload the assets and cache folders that are stored locally.<br><br>Possible values for deployment:<br>- NONE<br>- CREATE<br><br>This bucket is deployed to the region specified on the default AWS Terraform provider.<br><br>If deployment is set to `NONE`, then arn, region, name & domain\_name are required fields.<br><br>**WARNING:** The bucket is fundamental to the architecture, and the module is optional to facilitate sharing a bucket for multi-zone deployments and to support edge cases not supported by the module. With that said, it is not recommended to supply a bucket. | <pre>object({<br>    deployment           = optional(string, "CREATE")<br>    create_bucket_policy = optional(bool, true)<br>    force_destroy        = optional(bool, false)<br>    arn                  = optional(string)<br>    region               = optional(string)<br>    name                 = optional(string)<br>    domain_name          = optional(string)<br>  })</pre> | `{}` | no |
| <a name="input_zone_suffix"></a> [zone\_suffix](#input\_zone\_suffix) | An optional zone suffix to add to the assets and cache folder to allow files to be loaded correctly | `string` | `null` | no |

### Outputs

| Name | Description |
|------|-------------|
| <a name="output_alias_details"></a> [alias\_details](#output\_alias\_details) | The alias config |
| <a name="output_alternate_domain_names"></a> [alternate\_domain\_names](#output\_alternate\_domain\_names) | Extra CNAMEs (alternate domain names) associated with the cloudfront distribution |
| <a name="output_behaviours"></a> [behaviours](#output\_behaviours) | The behaviours for the zone |
| <a name="output_bucket_arn"></a> [bucket\_arn](#output\_bucket\_arn) | The ARN of the s3 bucket |
| <a name="output_bucket_name"></a> [bucket\_name](#output\_bucket\_name) | The name of the s3 bucket |
| <a name="output_cloudfront_distribution_id"></a> [cloudfront\_distribution\_id](#output\_cloudfront\_distribution\_id) | The ID for the cloudfront distribution |
| <a name="output_cloudfront_staging_distribution_id"></a> [cloudfront\_staging\_distribution\_id](#output\_cloudfront\_staging\_distribution\_id) | The ID for the cloudfront staging distribution |
| <a name="output_cloudfront_url"></a> [cloudfront\_url](#output\_cloudfront\_url) | The URL for the cloudfront distribution |
| <a name="output_custom_error_responses"></a> [custom\_error\_responses](#output\_custom\_error\_responses) | The custom error responses for the zone |
| <a name="output_zone_config"></a> [zone\_config](#output\_zone\_config) | The zone config |
